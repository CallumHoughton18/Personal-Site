{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/digest-auth-in-dotnet/","result":{"data":{"markdownRemark":{"html":"<p><strong>UPDATE (03/10/2022): .NET 6 should now successfully do digest authentication, <a href=\"https://github.com/CallumHoughton18/csharp-dotnet-digest-authentication/issues/1\">as kindly pointed by someone in the example repository</a>. Should save you the hassle of doing it manually, like in this blog post!</strong></p>\n<p>'The HttpClient class should handle this' I hear you say. Well, unfortunately setting network credentials on a HttpClient instance didn't seem to work for me. <a href=\"https://stackoverflow.com/questions/62190100/c-sharp-httpclient-digest-authentication-not-work\">Multiple</a> <a href=\"https://stackoverflow.com/questions/59939357/net-core-httpclient-digest-authentication\">people</a> <a href=\"https://stackoverflow.com/questions/65761976/net-5-httpclient-digest-authentication\">seem</a> <a href=\"https://github.com/dotnet/runtime/issues/50283\">to</a> be reporting that they also were running into issues. I couldn't find any information as to whether this should be fixed in .NET 6, plus I needed it to be portable to .NET Framework 4.8 (üíÄüíÄüíÄ). Either way, I'm going to run through how I implemented digest authentication as an extension method for the HttpClient class.</p>\n<p><strong>TL;DR: You can read the code in my GitHub repository <a href=\"https://github.com/CallumHoughton18/csharp-dotnet-digest-authentication\">here</a>, the README provides an example usage. For one request we generate two requests using my method as nothing (nonces, nonce counts) is cached. You can probably cache the header and implement the nonce count properly but that is beyond the scope of what I needed.</strong></p>\n<p>This isn't going to implement the full RFC specification for digest authentication. Instead it should be a pretty good starting point for people looking for something that 'just works'.</p>\n<p>I'll be using <a href=\"https://httpbin.org/\">Httpbin</a> to simulate the digest authentication workflow.</p>\n<h3>Prerequisites</h3>\n<ul>\n<li>Familiarity with .NET development</li>\n<li>Familiarity with HTTP</li>\n<li>A fuzzy idea of what digest authentication is and or knowledge of basic authentication</li>\n<li>Be frustrated that .NET doesn't do this for you (‚ùó<strong>IMPORTANT</strong>‚ùó)</li>\n</ul>\n<h3>Digest Authentication - An Overview</h3>\n<p><a href=\"https://en.wikipedia.org/wiki/Digest_access_authentication\">Wikipedia already gives a great overview</a> of how digest authentication works. If you want a more in depth explanation you should probably read that. But to follow along all you really need to know is:</p>\n<ul>\n<li>A request is sent, the server responds with a 401, and the response has a header like:</li>\n</ul>\n<blockquote>\n<p>WWW-Authenticate: Digest realm=\"<a href=\"mailto:testrealm@host.com\">testrealm@host.com</a>\",\nqop=\"auth\",\nnonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\",\nopaque=\"5ccc069c403ebaf9f0171e9517f40e41\"</p>\n</blockquote>\n<ul>\n<li>You parse the header and retrieve the realm, qop (quality of protection), nonce, and opaque challenges.</li>\n<li>Using a combination of the username, password, and nonces you calculate some new hashes and build up an Authorization header like:</li>\n</ul>\n<blockquote>\n<p>Authorization: Digest username=\"Mufasa\",\nrealm=\"<a href=\"mailto:testrealm@host.com\">testrealm@host.com</a>\",\nnonce=\"dcd98b7102dd2f0e8b11d0f600bfb0c093\",\nuri=\"/dir/index.html\",\nqop=auth,\nnc=00000001,\ncnonce=\"0a4f113b\",\nresponse=\"6629fae49393a05397450978507c4ef1\",\nopaque=\"5ccc069c403ebaf9f0171e9517f40e41\"</p>\n</blockquote>\n<ul>\n<li>You then resend the request with the given authorization header, which should allow you access to the resource.</li>\n</ul>\n<p>A couple of things to note here. One being that in my use case I only needed to use MD5 as my hashing algorithm. Digest authentication can also use SHA-256, and this is usually specified in the challenge <code class=\"language-text\">algorithm=SHA-256,</code> in the WWW-Authenticate header. <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/WWW-Authenticate\">Though the mdn web docs suggest this isn't really supported and rarely used</a> so for simplicity I haven't accounted for my use case.</p>\n<p>The last thing is that the quality of protection (qop) challenge can have more values than just 'auth'. Some examples you may see it like <code class=\"language-text\">qop=auth-int</code> where <code class=\"language-text\">auth-int</code> is authentication with integrity protection. Again, I didn't need to account for this for my use case.</p>\n<h3>Interpreting the 401 Error</h3>\n<p>Below, you can see the code for wiring up a HttpClient instance to try and get a resource at httpbin:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nclient<span class=\"token punctuation\">.</span>BaseAddress <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://httpbin.org\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">GetAsync</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/digest-auth/auth/username/password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You can see the response code is 401 if you inspect it with a debugger.</p>\n<p>Digging further you can see one of the response headers is <code class=\"language-text\">WWW-Authenticate: Digest realm=\"me@kennethreitz.com\", nonce=\"dd355b0ef0f19b473c6a6609aa288adb\", qop=\"auth\", opaque=\"5a6aa7c0f368ef5c3ae070778fcd54f2\", algorithm=MD5, stale=FALSE</code>. This is our first indication that this response is an authentication challenge response, it even gives us the authentication type: <code class=\"language-text\">Digest</code>.</p>\n<h3>Parsing the WWW-Authenticate Header</h3>\n<p>Using the code below we can parse the WWW-Authenticate header to pull out the values we need to generate an authorization header. Which will be added to our second, authenticated, request.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wwwAuthenticateHeaderValue <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">GetValues</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WWW-Authenticate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">FirstOrDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> realm <span class=\"token operator\">=</span> <span class=\"token function\">GrabHeaderVar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"realm\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> nonce <span class=\"token operator\">=</span> <span class=\"token function\">GrabHeaderVar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nonce\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> qop <span class=\"token operator\">=</span> <span class=\"token function\">GrabHeaderVar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"qop\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clientNonce <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Next</span><span class=\"token punctuation\">(</span><span class=\"token number\">123400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9999999</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> opaque <span class=\"token operator\">=</span> <span class=\"token function\">GrabHeaderVar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"opaque\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetChallengeValueFromHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> challengeName<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> fullHeaderValue<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// if variableName = qop, the below regex would look like qop=\"([^\"\"]*)\"</span>\n    <span class=\"token comment\">// So it matches anything with the challenge name and then gets the challenge value</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> regHeader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Regex</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$@\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">challengeName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">=\"\"([^\"\"]*)\"\"\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> matchHeader <span class=\"token operator\">=</span> regHeader<span class=\"token punctuation\">.</span><span class=\"token function\">Match</span><span class=\"token punctuation\">(</span>fullHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>matchHeader<span class=\"token punctuation\">.</span>Success<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> matchHeader<span class=\"token punctuation\">.</span>Groups<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ApplicationException</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Header </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">challengeName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> not found\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I then opt'd to throw the parsed challenge values into a class just to make it easier to manage. You'll also notice here I'm not doing anything fancy with maintaining the nonce count state. <strong>This is because if the server see's the same nonce count for a previously sent nonce, the response will be a replay</strong>. This was fine for my use case where I was just accessing static content, but it's something to keep in mind. This <em>might</em> lead to servers rejecting a request if they interpret it as a replay attack. That sounds like a problem for another day to me üëâüòéüëâ.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> digestHeader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DigestAuthHeader</span><span class=\"token punctuation\">(</span>realm<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">,</span> qop<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">nonceCount</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> clientNonce<span class=\"token punctuation\">,</span> opaque<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">internal</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DigestAuthHeader</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">DigestAuthHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> realm<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> username<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> nonce<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> qualityOfProtection<span class=\"token punctuation\">,</span> \n        <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> nonceCount<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> clientNonce<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> opaque<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Realm <span class=\"token operator\">=</span> realm<span class=\"token punctuation\">;</span>\n        Username <span class=\"token operator\">=</span> username<span class=\"token punctuation\">;</span>\n        Password <span class=\"token operator\">=</span> password<span class=\"token punctuation\">;</span>\n        Nonce <span class=\"token operator\">=</span> nonce<span class=\"token punctuation\">;</span>\n        QualityOfProtection <span class=\"token operator\">=</span> qualityOfProtection<span class=\"token punctuation\">;</span>\n        NonceCount <span class=\"token operator\">=</span> nonceCount<span class=\"token punctuation\">;</span>\n        ClientNonce <span class=\"token operator\">=</span> clientNonce<span class=\"token punctuation\">;</span>\n        Opaque <span class=\"token operator\">=</span> opaque<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Realm <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Username <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Password <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Nonce <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> QualityOfProtection <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> NonceCount <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> ClientNonce <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Opaque <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Generating the Challenge Response Header</h3>\n<p>With the challenge values pulled out we can generate the challenge response <code class=\"language-text\">Authorization</code> header value, using the code below:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GenerateMD5Hash</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> input<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// x2 formatter is for hexadecimal in the ToString function</span>\n    <span class=\"token keyword\">using</span> <span class=\"token class-name\">MD5</span> hash <span class=\"token operator\">=</span> MD5<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Concat</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">.</span><span class=\"token function\">ComputeHash</span><span class=\"token punctuation\">(</span>Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetBytes</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                <span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span> x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> \n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetDigestHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DigestAuthHeader</span> digest<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> digestUri<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpMethod</span> method<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ha1 <span class=\"token operator\">=</span> <span class=\"token function\">GenerateMD5Hash</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Username</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Realm</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Password</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> ha2 <span class=\"token operator\">=</span> <span class=\"token function\">GenerateMD5Hash</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">method</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digestUri</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> digestResponse <span class=\"token operator\">=</span>\n        <span class=\"token function\">GenerateMD5Hash</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">ha1</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Nonce</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>NonceCount</span><span class=\"token format-string\"><span class=\"token punctuation\">:</span>00000000</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>ClientNonce</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>QualityOfProtection</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">ha2</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> headerString <span class=\"token operator\">=</span>\n        <span class=\"token interpolation-string\"><span class=\"token string\">$\"Digest username=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Username</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", realm=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Realm</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", nonce=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Nonce</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", uri=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digestUri</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", \"</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token interpolation-string\"><span class=\"token string\">$\"algorithm=MD5, qop=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>QualityOfProtection</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, nc=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>NonceCount</span><span class=\"token format-string\"><span class=\"token punctuation\">:</span>00000000</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">, cnonce=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>ClientNonce</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", \"</span></span> <span class=\"token operator\">+</span>\n        <span class=\"token interpolation-string\"><span class=\"token string\">$\"response=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digestResponse</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\", opaque=\\\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">digest<span class=\"token punctuation\">.</span>Opaque</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\\"\"</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> headerString<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Because I'm super lazy, I'll copy and paste the Wikipedia explanation that links to the above code section:</p>\n<p>The \"response\" value is calculated in three steps, as follows. Where values are combined, they are delimited by colons.</p>\n<ol>\n<li>The MD5 hash of the combined username, authentication realm and password is calculated. The result is referred to as Ha1.</li>\n<li>The MD5 hash of the combined method and digest URI is calculated, e.g. of \"GET\" and \"/dir/index.html\". The result is referred to as Ha2.</li>\n<li>The MD5 hash of the combined HA1 result, server nonce (nonce), request counter (nc), client nonce (cnonce), quality of protection code (qop) and HA2 result is calculated. The result is the \"response\" value provided by the client.</li>\n</ol>\n<h3>Extending the HttpClient class</h3>\n<p>I decided to wrap all this authentication and re-sending requests in an extension method, which you can see below:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>HttpResponseMessage<span class=\"token punctuation\">></span></span> <span class=\"token function\">SendWithDigestAuthAsync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">HttpClient</span> client<span class=\"token punctuation\">,</span> \n    <span class=\"token class-name\">HttpRequestMessage</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpCompletionOption</span> httpCompletionOption<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> username<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> newRequest <span class=\"token operator\">=</span> <span class=\"token function\">CloneBeforeContentSet</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">SendAsync</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> httpCompletionOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>StatusCode <span class=\"token operator\">!=</span> System<span class=\"token punctuation\">.</span>Net<span class=\"token punctuation\">.</span>HttpStatusCode<span class=\"token punctuation\">.</span>Unauthorized<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> wwwAuthenticateHeaderValue <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">GetValues</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WWW-Authenticate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">FirstOrDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> realm <span class=\"token operator\">=</span> <span class=\"token function\">GetChallengeValueFromHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"realm\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> nonce <span class=\"token operator\">=</span> <span class=\"token function\">GetChallengeValueFromHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nonce\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> qop <span class=\"token operator\">=</span> <span class=\"token function\">GetChallengeValueFromHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"qop\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Must be fresh on every request, so low chance of same client nonce here by just using a random number.</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> clientNonce <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Next</span><span class=\"token punctuation\">(</span><span class=\"token number\">123400</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9999999</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> opaque <span class=\"token operator\">=</span> <span class=\"token function\">GetChallengeValueFromHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"opaque\"</span><span class=\"token punctuation\">,</span> wwwAuthenticateHeaderValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> digestHeader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">DigestAuthHeader</span><span class=\"token punctuation\">(</span>realm<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">,</span> nonce<span class=\"token punctuation\">,</span> qop<span class=\"token punctuation\">,</span> <span class=\"token named-parameter punctuation\">nonceCount</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> clientNonce<span class=\"token punctuation\">,</span> opaque<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> digestRequestHeader <span class=\"token operator\">=</span> <span class=\"token function\">GetDigestHeader</span><span class=\"token punctuation\">(</span>digestHeader<span class=\"token punctuation\">,</span> newRequest<span class=\"token punctuation\">.</span>RequestUri<span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    newRequest<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">,</span> digestRequestHeader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> authRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">SendAsync</span><span class=\"token punctuation\">(</span>newRequest<span class=\"token punctuation\">,</span> httpCompletionOption<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> authRes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\">HttpRequestMessage</span> <span class=\"token function\">CloneBeforeContentSet</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">HttpRequestMessage</span> req<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Deep clone of a given request, outlined here:</span>\n    <span class=\"token comment\">// https://stackoverflow.com/questions/18000583/re-send-httprequestmessage-exception/18014515#18014515</span>\n    <span class=\"token class-name\">HttpRequestMessage</span> clone <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpRequestMessage</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>RequestUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    clone<span class=\"token punctuation\">.</span>Content <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>Content<span class=\"token punctuation\">;</span>\n    clone<span class=\"token punctuation\">.</span>Version <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>Version<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">KeyValuePair<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span><span class=\"token punctuation\">></span></span> prop <span class=\"token keyword\">in</span> req<span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        clone<span class=\"token punctuation\">.</span>Properties<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>prop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">KeyValuePair<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> IEnumerable<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> header <span class=\"token keyword\">in</span> req<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        clone<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">TryAddWithoutValidation</span><span class=\"token punctuation\">(</span>header<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">,</span> header<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> clone<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>The Final Call ü§û</h3>\n<p>With all the nasty authentication stuff abstracted away the final function calls should look fairly simple and you're really just substituting one method call:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nclient<span class=\"token punctuation\">.</span>BaseAddress <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://httpbin.org\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">HttpRequestMessage</span><span class=\"token punctuation\">(</span>HttpMethod<span class=\"token punctuation\">.</span>Get<span class=\"token punctuation\">,</span> <span class=\"token string\">\"/digest-auth/auth/username/password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Accept\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"*/*\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"User-Agent\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HttpClientDigestAuthTester\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Accept-Encoding\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"gzip, deflate, br\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nrequest<span class=\"token punctuation\">.</span>Headers<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Connection\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"keep-alive\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// This will no respond with a 200 status code</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">SendWithDigestAuthAsync</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> HttpCompletionOption<span class=\"token punctuation\">.</span>ResponseContentRead<span class=\"token punctuation\">,</span> <span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// this is what originally gave a 401 status code</span>\n<span class=\"token comment\">//var response = await client.GetAsync(\"/digest-auth/auth/username/password\");</span></code></pre></div>\n<p>Inspecting the response object should show it now responds with a 200 status code, so we've successfully performed the authentication dance with the server!</p>\n<h3>Final Words</h3>\n<p>Hopefully someone informs me that there's a simpler more '.NET' way of doing this. Where .NET does most of the heavy lifting for you. If anyone does, be sure to reach out and I'll happily strike through this entire post and point out the better way of doing it.</p>\n<p>As I mentioned in a previous section this implementation is far from implementing the full RFC specification for digest authentication, but it should be a decent starting point.</p>\n<p>The code for this is on my <a href=\"https://github.com/CallumHoughton18/csharp-dotnet-digest-authentication\">GitHub</a> so feel free to have a look through or make any suggestions.</p>","frontmatter":{"title":"Implementing Digest Authentication in .NET","date":"2022-05-04T00:00:00.000Z"}}},"pageContext":{"slug":"/blog/digest-auth-in-dotnet/"}},"staticQueryHashes":["2263501977"]}